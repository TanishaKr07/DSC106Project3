* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background-color: #1a1a2e;
    color: white;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
}

.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100vw;
}

.header {
    background-color: #2d2d44;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    flex-shrink: 0;
}

h1 {
    font-size: 24px;
    margin-bottom: 15px;
}

.controls {
    display: flex;
    align-items: center;
}

.year-control {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}

.year-label {
    font-weight: 600;
    min-width: 100px;
}

.slider {
    flex: 1;
    height: 8px;
    background: #4a4a6a;
    border-radius: 5px;
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

.year-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
}

.btn:hover {
    background-color: #2563eb;
}

.btn:disabled {
    background-color: #4a4a6a;
    cursor: not-allowed;
}

.map-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    cursor: ew-resize;
    background-color: #1a1a2e;
    min-height: 0;
}

.canvas-wrapper {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
}

canvas {
    width: 100%;
    height: 100%;
    display: block;
}

.right-map {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    clip-path: inset(0 0 0 50%);
    pointer-events: none;
}

.slider-line {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    width: 4px;
    background-color: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    pointer-events: none;
    z-index: 10;
}

.slider-handle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background-color: white;
    border-radius: 50%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
}

.slider-handle::before,
.slider-handle::after {
    content: '';
    width: 2px;
    height: 16px;
    background-color: #666;
    position: absolute;
}

.slider-handle::before {
    left: 14px;
}

.slider-handle::after {
    right: 14px;
}

.legend {
    background-color: #2d2d44;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    flex-shrink: 0;
}

.legend-label {
    font-size: 14px;
}

.color-scale {
    height: 30px;
    width: 300px;
    border-radius: 5px;
    overflow: hidden;
    display: flex;
}

.instruction {
    background-color: #2d2d44;
    padding: 0 20px 20px;
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
    flex-shrink: 0;
}

.brush-layer .selection {
  stroke: #fff;
  fill: rgba(255, 255, 255, 0.2);
  stroke-width: 1.5;
}

function computeYearlyAverages() {
    const sums = {};
    const counts = {};

    data.forEach(d => {
        if (!sums[d.year]) {
            sums[d.year] = 0;
            counts[d.year] = 0;
        }
        sums[d.year] += d.pr_mm_day;
        counts[d.year] += 1;
    });

    yearlyAverages = years
        .filter(y => sums[y] !== undefined)
        .map(y => ({
            year: y,
            avg: sums[y] / counts[y]
        }));
}

function drawLineChart() {
    if (!lineCanvas || yearlyAverages.length === 0) return;

    const ctx = lineCanvas.getContext('2d');
    const width = lineCanvas.width;
    const height = lineCanvas.height;

    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);

    const paddingLeft = 50;
    const paddingRight = 20;
    const paddingTop = 30;
    const paddingBottom = 30;

    const x0 = paddingLeft;
    const y0 = height - paddingBottom;
    const x1 = width - paddingRight;
    const y1 = paddingTop;

    const minYear = yearlyAverages[0].year;
    const maxYear = yearlyAverages[yearlyAverages.length - 1].year;

    let minVal = Math.min(...yearlyAverages.map(d => d.avg));
    let maxVal = Math.max(...yearlyAverages.map(d => d.avg));

    if (minVal === maxVal) {
        minVal *= 0.9;
        maxVal *= 1.1;
    }

    const xScale = year =>
        x0 + ((year - minYear) / (maxYear - minYear || 1)) * (x1 - x0);

    const yScale = val =>
        y0 - ((val - minVal) / (maxVal - minVal || 1)) * (y0 - y1);

    // Axes
    ctx.strokeStyle = '#6b7280';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y0); // x-axis
    ctx.moveTo(x0, y0);
    ctx.lineTo(x0, y1); // y-axis
    ctx.stroke();

    // Y ticks
    const yTicks = 3;
    ctx.font = '12px Arial';
    ctx.fillStyle = '#9ca3af';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';

    for (let i = 0; i <= yTicks; i++) {
        const t = i / yTicks;
        const val = minVal + t * (maxVal - minVal);
        const y = yScale(val);

        ctx.fillText(val.toFixed(2), x0 - 8, y);

        ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
        ctx.beginPath();
        ctx.moveTo(x0, y);
        ctx.lineTo(x1, y);
        ctx.stroke();
    }

    // X labels (each year)
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillStyle = '#9ca3af';
    yearlyAverages.forEach(d => {
        const x = xScale(d.year);
        ctx.fillText(d.year, x, y0 + 4);
    });

    // Line
    ctx.strokeStyle = '#38bdf8';
    ctx.lineWidth = 2;
    ctx.beginPath();
    yearlyAverages.forEach((d, i) => {
        const x = xScale(d.year);
        const y = yScale(d.avg);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Points
    ctx.fillStyle = '#38bdf8';
    yearlyAverages.forEach(d => {
        const x = xScale(d.year);
        const y = yScale(d.avg);
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
    });

    // Title
    ctx.fillStyle = 'white';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Average precipitation (mm/day) by year', x0, paddingTop - 22);
}

